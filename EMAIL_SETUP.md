# Настройка автоматической отправки результатов на email

Приложение автоматически отправляет результаты теста на email клиента после завершения тестирования. Email включает:
- Текстовое описание результатов
- Показатели dB (средний, левое ухо, правое ухо)
- PDF файл с полным отчетом и аудиограммами

## Как это работает

1. Клиент заполняет форму с указанием email
2. Проходит тест слуха
3. На странице результатов автоматически:
   - Генерируется PDF с результатами
   - Отправляется email с PDF вложением
   - Отображается статус отправки

## Настройка SMTP

### 1. Выберите email сервис

Вам нужен SMTP сервер для отправки писем. Варианты:

**Вариант A: Gmail (Бесплатно)**
- Простая настройка
- До 500 писем в день
- Требует App Password

**Вариант B: Mail.ru / Яндекс (Бесплатно)**
- Для русскоязычных клиентов
- Простая настройка

**Вариант C: SendGrid / Mailgun / AWS SES (Платно)**
- Профессиональные сервисы
- Больше лимитов
- Лучшая доставляемость

### 2. Настройте Gmail (рекомендуемый вариант для старта)

#### Шаг 1: Создайте App Password

1. Откройте https://myaccount.google.com/
2. Перейдите в **Security** → **2-Step Verification**
3. Включите двухфакторную аутентификацию (если еще не включена)
4. Вернитесь в **Security** → **App passwords**
5. Выберите:
   - App: **Mail**
   - Device: **Other** (введите "Hearing Test")
6. Нажмите **Generate**
7. Скопируйте сгенерированный пароль (16 символов)

#### Шаг 2: Настройте .env

В файле `server/.env`:

```env
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=xxxx xxxx xxxx xxxx  # App Password из шага 1
EMAIL_FROM_NAME=Тест слуха
```

**Важно:** Используйте App Password, НЕ обычный пароль от Gmail!

### 3. Настройте Mail.ru

В файле `server/.env`:

```env
SMTP_HOST=smtp.mail.ru
SMTP_PORT=465
SMTP_SECURE=true
SMTP_USER=your-email@mail.ru
SMTP_PASS=your-password
EMAIL_FROM_NAME=Тест слуха
```

### 4. Настройте Яндекс

В файле `server/.env`:

```env
SMTP_HOST=smtp.yandex.ru
SMTP_PORT=465
SMTP_SECURE=true
SMTP_USER=your-email@yandex.ru
SMTP_PASS=your-password
EMAIL_FROM_NAME=Тест слуха
```

### 5. Настройте SendGrid

1. Зарегистрируйтесь на https://sendgrid.com
2. Создайте API ключ
3. В файле `server/.env`:

```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
EMAIL_FROM_NAME=Тест слуха
```

## Проверка настроек

### 1. Установите зависимости

```bash
cd server
npm install
```

### 2. Запустите backend

```bash
npm run dev
```

### 3. Проверьте конфигурацию

```bash
curl http://localhost:3001/api/email/verify
```

Ожидаемый ответ:
```json
{
  "configured": true,
  "message": "Email service is configured and ready"
}
```

Если `configured: false`, проверьте:
- SMTP_HOST, SMTP_USER, SMTP_PASS заполнены
- Правильность учетных данных
- Логи в терминале backend

### 4. Тестовая отправка

Пройдите тест до конца и проверьте:
- В терминале backend появилось: `Sending email to: ...`
- На странице результатов: "✅ Результаты успешно отправлены на ваш email"
- Email пришел на указанный адрес

## Troubleshooting

### Email не отправляется

**1. Проверьте логи backend:**
```bash
# В терминале где запущен backend смотрите сообщения об ошибках
```

**2. Проверьте SMTP настройки:**
```bash
curl http://localhost:3001/api/email/verify
```

**3. Частые ошибки:**

#### "SMTP settings not configured"
- Проверьте что `.env` файл создан в папке `server/`
- Убедитесь что все переменные SMTP заполнены

#### "Invalid login: 535" (Gmail)
- Используете обычный пароль вместо App Password
- Решение: Создайте App Password (см. инструкцию выше)

#### "Connection timeout"
- Неправильный SMTP_HOST или SMTP_PORT
- Проверьте настройки для вашего провайдера

#### "Authentication failed"
- Неправильный SMTP_USER или SMTP_PASS
- Проверьте логин и пароль

### Email уходит в спам

**Решение:**
1. Настройте SPF/DKIM записи для вашего домена
2. Используйте профессиональный SMTP сервис (SendGrid, Mailgun)
3. Попросите клиентов добавить ваш email в контакты

### PDF не прикрепляется

- Проверьте логи: есть ли ошибки генерации PDF
- Проверьте что графики отрисованы (видны на странице)
- Проверьте лимит размера: `express.json({ limit: '10mb' })` в server.js

## Структура email

### Тема письма:
```
Результаты вашего теста слуха - [Результат]
```

### Содержимое:
- Приветствие с ФИО клиента
- Результат теста ("Нормальный слух", "Легкая степень", и т.д.)
- Показатели в dB
- Описание результата
- Примечание о том, что тест ориентировочный
- PDF во вложении

### Вложение:
```
hearing-test-Иван-Петров.pdf
```
Содержит:
- Данные пациента
- Аудиограммы (ваши результаты + норма)
- Описание результата
- Рекомендации по слуховому аппарату
- Контакты клиники

## Лимиты отправки

### Gmail:
- 500 писем в день (бесплатно)
- Подходит для: до 500 тестов в день

### Mail.ru / Яндекс:
- ~100-500 писем в день
- Подходит для: небольших объемов

### SendGrid:
- 100 писем в день (бесплатно)
- От $14.95/мес за 40,000 писем
- Подходит для: средних и больших объемов

### Mailgun:
- 5,000 писем в месяц (бесплатно)
- От $35/мес за 50,000 писем
- Подходит для: средних объемов

## Production рекомендации

### Для небольших объемов (до 50 тестов в день):
✅ Gmail с App Password - достаточно

### Для средних объемов (50-500 тестов в день):
✅ SendGrid или Mailgun - надежнее

### Для больших объемов (500+ тестов в день):
✅ AWS SES или профессиональный SMTP сервис

## Мониторинг

### Проверяйте логи backend:
```bash
# Успешная отправка:
Sending email to: client@example.com
Email sent successfully

# Ошибка:
Error sending email: [описание ошибки]
```

### Метрики для отслеживания:
- Количество отправленных писем в день
- Процент успешных отправок
- Ошибки доставки
- Жалобы на спам

## Дополнительно

### Изменить шаблон письма:
Откройте `server/services/emailService.js` и отредактируйте HTML в функции `sendTestResults()`

### Изменить тему письма:
```javascript
// В emailService.js:
subject: `Ваши результаты теста - ${testResult}` // измените здесь
```

### Отключить отправку email:
Если нужно временно отключить:
1. Удалите или закомментируйте SMTP настройки в `.env`
2. Приложение будет работать без отправки email

## Поддержка

При проблемах:
1. Проверьте логи backend
2. Проверьте /api/email/verify endpoint
3. Проверьте что `.env` файл настроен правильно
4. Убедитесь что nodemailer установлен: `npm install`
